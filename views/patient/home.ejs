<% layout('layout') -%>

<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold mb-1">Welcome, <%= patient.name %>!</h2>
                    <p class="text-muted mb-0">Your comprehensive healthcare dashboard</p>
                </div>
                <div>
                    <a href="/patient/dashboard" class="btn btn-outline-primary me-2">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                    <a href="/patient/logout" class="btn btn-outline-danger">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Doctors Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-search me-2"></i>Find Doctors</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="doctorSearch" placeholder="Search by doctor name or specialty...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="specialtyFilter">
                                <option value="">All Specialties</option>
                                <option value="Cardiology">Cardiology</option>
                                <option value="Dermatology">Dermatology</option>
                                <option value="Pediatrics">Pediatrics</option>
                                <option value="Orthopedics">Orthopedics</option>
                                <option value="Neurology">Neurology</option>
                                <option value="General Medicine">General Medicine</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="searchDoctors()">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="row g-4">
        <!-- Left Column - Services -->
        <div class="col-lg-8">
            <!-- Available Doctors -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-user-md me-2"></i>Available Doctors</h5>
                </div>
                <div class="card-body">
                    <div class="row" id="doctorsList">
                        <% doctors.forEach(function(doctor) { %>
                            <div class="col-md-6 mb-3">
                                <div class="card border">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="feature-icon me-3" style="width: 50px; height: 50px;">
                                                <i class="fas fa-user-md"></i>
                                            </div>
                                            <div>
                                                <h6 class="fw-bold mb-1"><%= doctor.name %></h6>
                                                <p class="text-muted mb-0"><%= doctor.specialization %></p>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <small class="text-muted">
                                                <i class="fas fa-clock me-1"></i>
                                                <%= doctor.yearsOfExperience %> years experience
                                            </small>
                                        </div>
                                        <button class="btn btn-primary btn-sm w-100" onclick="bookAppointment('<%= doctor._id %>', '<%= doctor.name %>', '<%= doctor.specialization %>')">
                                            <i class="fas fa-calendar-plus me-2"></i>Book Appointment
                                        </button>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                </div>
            </div>

            <!-- Quick Services -->
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card h-100 text-center">
                        <div class="card-body">
                            <div class="feature-icon mx-auto mb-3">
                                <i class="fas fa-video"></i>
                            </div>
                            <h6 class="fw-bold">Video Consultation</h6>
                            <p class="text-muted small">Connect with doctors via video call</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="startVideoCall()">Start Call</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100 text-center">
                        <div class="card-body">
                            <div class="feature-icon mx-auto mb-3">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h6 class="fw-bold">Chat with Doctor</h6>
                            <p class="text-muted small">Get instant medical advice</p>
                            <a href="/patient/chat" class="btn btn-outline-primary btn-sm">Start Chat</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Quick Access -->
        <div class="col-lg-4">
            <!-- Emergency Services -->
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-ambulance me-2"></i>Emergency Services</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="tel:108" class="btn btn-danger btn-lg">
                            <i class="fas fa-phone me-2"></i>
                            Emergency (108)
                        </a>
                        <a href="tel:102" class="btn btn-warning btn-lg">
                            <i class="fas fa-ambulance me-2"></i>
                            Ambulance (102)
                        </a>
                    </div>
                </div>
            </div>

            <!-- Nearby Hospitals -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-hospital me-2"></i>Hospitals Near Me</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Apollo Hospital</strong>
                                <br><small class="text-muted">2.5 km away</small>
                            </div>
                            <button class="btn btn-outline-primary btn-sm">Directions</button>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Fortis Healthcare</strong>
                                <br><small class="text-muted">3.2 km away</small>
                            </div>
                            <button class="btn btn-outline-primary btn-sm">Directions</button>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Max Hospital</strong>
                                <br><small class="text-muted">4.1 km away</small>
                            </div>
                            <button class="btn btn-outline-primary btn-sm">Directions</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blood Bank -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-tint me-2"></i>Blood Bank</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="text-danger fw-bold">A+</div>
                                <small class="text-muted">Available</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="text-danger fw-bold">B+</div>
                                <small class="text-muted">Low</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="text-danger fw-bold">O+</div>
                                <small class="text-muted">Available</small>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-outline-warning btn-sm w-100 mt-3">View All Stocks</button>
                </div>
            </div>

            <!-- Rehabilitation Centers -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-wheelchair me-2"></i>Rehabilitation Centers</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>PhysioCare Center</strong>
                                <br><small class="text-muted">1.8 km away</small>
                            </div>
                            <button class="btn btn-outline-success btn-sm">Contact</button>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Rehab Solutions</strong>
                                <br><small class="text-muted">2.3 km away</small>
                            </div>
                            <button class="btn btn-outline-success btn-sm">Contact</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Section -->
    <div class="row mt-4">
        <!-- User Profile -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>User Profile</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="feature-icon me-3" style="width: 50px; height: 50px;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-1"><%= patient.name %></h6>
                            <p class="text-muted mb-0"><%= patient.age %> years, <%= patient.gender %></p>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm">Edit Profile</button>
                        <button class="btn btn-outline-secondary btn-sm">View Medical Records</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Medicine Records -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-prescription-bottle-alt me-2"></i>Medicine Records</h5>
                </div>
                <div class="card-body">
                    <% if (patient.prescriptions && patient.prescriptions.length > 0) { %>
                        <div class="list-group list-group-flush">
                            <% patient.prescriptions.slice(0, 3).forEach(function(prescription) { %>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong><%= prescription.originalName %></strong>
                                        <br><small class="text-muted"><%= new Date(prescription.uploadDate).toLocaleDateString() %></small>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm">View</button>
                                </div>
                            <% }); %>
                        </div>
                    <% } else { %>
                        <div class="text-center py-3">
                            <i class="fas fa-file-medical text-muted" style="font-size: 32px;"></i>
                            <p class="text-muted mt-2">No prescriptions uploaded yet</p>
                        </div>
                    <% } %>
                    <button class="btn btn-primary btn-sm w-100 mt-3" onclick="showPrescriptionModal()">
                        <i class="fas fa-upload me-2"></i>Upload Prescription
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointments Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Current & Previous Appointments</h5>
                </div>
                <div class="card-body">
                    <% if (patient.appointments && patient.appointments.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Doctor</th>
                                        <th>Specialization</th>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% patient.appointments.forEach(function(appointment) { %>
                                        <tr>
                                            <td><%= appointment.doctorName %></td>
                                            <td><%= appointment.specialization %></td>
                                            <td><%= new Date(appointment.appointmentDate).toLocaleDateString() %></td>
                                            <td><%= new Date(appointment.appointmentDate).toLocaleTimeString() %></td>
                                            <td>
                                                <span class="badge bg-<%= appointment.status === 'Scheduled' ? 'primary' : appointment.status === 'Completed' ? 'success' : 'danger' %>">
                                                    <%= appointment.status %>
                                                </span>
                                            </td>
                                            <td>
                                                <% if (appointment.status === 'Scheduled') { %>
                                                    <button class="btn btn-outline-primary btn-sm me-2" onclick="startVideoCall()">Join Call</button>
                                                    <button class="btn btn-outline-danger btn-sm">Cancel</button>
                                                <% } else { %>
                                                    <button class="btn btn-outline-secondary btn-sm">View Details</button>
                                                <% } %>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-times text-muted" style="font-size: 48px;"></i>
                            <p class="text-muted mt-3">No appointments scheduled</p>
                            <p class="text-muted">Book your first appointment with a doctor above</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- FAQs Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>Frequently Asked Questions</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="faqAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                    How do I book an appointment?
                                </button>
                            </h2>
                            <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    Simply search for a doctor using the search bar above, select your preferred doctor, and click "Book Appointment". You'll be able to choose a date and time that works for you.
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                    How do video consultations work?
                                </button>
                            </h2>
                            <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    Video consultations are conducted through our secure platform. You'll receive a link to join the call at your scheduled appointment time. Make sure you have a stable internet connection and a working camera/microphone.
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                    Can I upload my prescriptions?
                                </button>
                            </h2>
                            <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    Yes! You can upload prescription images or PDFs using the "Upload Prescription" button. This helps doctors understand your medical history and current medications.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Book Appointment Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-calendar-plus me-2"></i>Book Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    <input type="hidden" id="selectedDoctorId" name="doctorId">
                    <div class="mb-3">
                        <label class="form-label">Doctor</label>
                        <input type="text" class="form-control" id="selectedDoctorName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Specialization</label>
                        <input type="text" class="form-control" id="selectedDoctorSpecialty" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="appointmentDate" class="form-label">Appointment Date & Time</label>
                        <input type="datetime-local" class="form-control" id="appointmentDate" name="appointmentDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Describe your symptoms or concerns..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmAppointment()">Book Appointment</button>
            </div>
        </div>
    </div>
</div>

<!-- Prescription Upload Modal -->
<div class="modal fade" id="prescriptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-upload me-2"></i>Upload Prescription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="prescriptionForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="prescription" class="form-label">Select Prescription File</label>
                        <input type="file" class="form-control" id="prescription" name="prescription" accept=".pdf,.jpg,.jpeg,.png" required>
                        <div class="form-text">Supported formats: PDF, JPG, JPEG, PNG</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadPrescription()">Upload</button>
            </div>
        </div>
    </div>
</div>

<script>
function searchDoctors() {
    const searchTerm = document.getElementById('doctorSearch').value.toLowerCase();
    const specialtyFilter = document.getElementById('specialtyFilter').value;
    
    const doctorCards = document.querySelectorAll('#doctorsList .col-md-6');
    
    doctorCards.forEach(card => {
        const doctorName = card.querySelector('h6').textContent.toLowerCase();
        const specialty = card.querySelector('p').textContent.toLowerCase();
        
        const matchesSearch = doctorName.includes(searchTerm) || specialty.includes(searchTerm);
        const matchesSpecialty = !specialtyFilter || specialty.includes(specialtyFilter.toLowerCase());
        
        if (matchesSearch && matchesSpecialty) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function bookAppointment(doctorId, doctorName, specialty) {
    document.getElementById('selectedDoctorId').value = doctorId;
    document.getElementById('selectedDoctorName').value = doctorName;
    document.getElementById('selectedDoctorSpecialty').value = specialty;
    
    new bootstrap.Modal(document.getElementById('appointmentModal')).show();
}

function confirmAppointment() {
    const formData = new FormData(document.getElementById('appointmentForm'));
    
    fetch('/patient/book-appointment', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('appointmentModal')).hide();
            alert('Appointment booked successfully!');
            location.reload();
        } else {
            alert('Failed to book appointment');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to book appointment');
    });
}

function uploadPrescription() {
    const formData = new FormData(document.getElementById('prescriptionForm'));
    
    fetch('/patient/upload-prescription', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('prescriptionModal')).hide();
            alert('Prescription uploaded successfully!');
            location.reload();
        } else {
            alert('Failed to upload prescription');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to upload prescription');
    });
}

// Set minimum date to today
document.getElementById('appointmentDate').min = new Date().toISOString().slice(0, 16);

// Start video call function
function startVideoCall() {
    // Check if browser supports WebRTC
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Your browser does not support video calls. Please use a modern browser like Chrome, Firefox, or Safari.');
        return;
    }
    
    // Redirect to video call page
    window.location.href = '/patient/video-call';
}
</script>
